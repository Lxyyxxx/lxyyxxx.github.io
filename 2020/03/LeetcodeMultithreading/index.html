<!-- 不变的布局 -->
<!DOCTYPE html>
<html>
<!-- head -->

<head><meta name="generator" content="Hexo 3.9.0">
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    

    <title>
        
        「LeetCode」多线程 - Lin Xinyu
        
    </title>

    <!-- theme css -->
    <link rel="stylesheet" href="/css/write.css">

    <!-- tocbot -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/tocbot/4.4.2/tocbot.css">

    <!-- katex -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">

    <!-- bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <!-- highlight -->
    <link href="https://fonts.googleapis.com/css?family=Fira+Code&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.18.1/styles/xcode.min.css">

    <!-- font awesome -->
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.13.0/css/all.min.css" rel="stylesheet">

    <!-- font -->
    <link href="https://fonts.googleapis.com/css?family=Comic+Neue|Schoolbell&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:400,700,900&display=swap" rel="stylesheet">

    <script src="/js/search.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="write-wrapper">
        <!-- 顶部导航栏 -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm" id="write-navbar-parent">
    <div class="container">
        <div class="navbar-brand">
            <a href="/" class="write-logo">Lin Xinyu</a>
        </div>
        <div class="write-collapse-button">
            <a role="button" data-toggle="collapse" href="#write-collapse-navbar" data-parent="#write-navbar-parent">
                <i class="fas fa-bars"></i>
            </a>
        </div>
        <div class="collapse navbar-collapse in" id="write-collapse-navbar">
            <ul class="navbar-nav font-weight-bold">
                <!-- 顶部导航栏 -->
                
                <li class="nav-item">
                    <a href="/" class="nav-link">
                        首页
                    </a>
                </li>
                
                <li class="nav-item">
                    <a href="/archives" class="nav-link">
                        归档
                    </a>
                </li>
                
                <li class="nav-item">
                    <a href="/categories" class="nav-link">
                        分类
                    </a>
                </li>
                
                <li class="nav-item">
                    <a href="/tags" class="nav-link">
                        标签
                    </a>
                </li>
                
            </ul>
            <div class="write-search">
                <a role="button" class="popup-trigger">
                    <i class="fas fa-search"></i>
                </a>
            </div>
            <div class="write-rss">
                <a role="button" href="/atom.xml" target="_blank">
                    <i class="fas fa-rss"></i>
                </a>
            </div>
        </div>
    </div>
</nav>
<div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
            <span class="search-icon">
                <i class="fa fa-search"></i>
            </span>
            <div class="search-input-container">
                <input autocomplete="off" autocapitalize="off" placeholder="搜索中..."
                    spellcheck="false" type="search" class="search-input">
            </div>
            <span class="popup-btn-close">
                <i class="fa fa-times-circle"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>
<br />
        <!-- 文章 -->
<div class="container-fluid">
    <div class="row">
        <div class="d-none d-xl-block col-xl-2"></div>
        <div class="col-md-9 col-xl-6 pl-md-5">
            <div class="card border-0 shadow">
                <div class="card-body">
                    <div class="write-title">
                        <h2 class="write-post-title">「LeetCode」多线程</h2>
                    </div>
                    <div class="write-meta">
                        <div class="write-post-time">
                            <!-- 如果更新时间大于发布时间则显示更新时间 -->
                            
                            <!-- update time -->
                            Updated at
                            <time datetime="2022-10-09T13:59:04.735Z" itemprop="dateModified">
                            2022-10-09 21:59
                            </time>
                            
                        </div>
                        <!-- categories -->
                        
                        
                        <i class="fas fa-folder"></i>
                        
                        <a
                            href='/categories/LeetCode/'>LeetCode</a>
                        
                        
                        &emsp;
                        <!-- tags -->
                        
                        
                        <i class="fas fa-tags"></i>
                        
                        <a
                            href='/tags/LeetCode/'>LeetCode</a>, 
                        
                        <a
                            href='/tags/多线程/'>多线程</a>
                        
                        
                    </div>
                    <article class="write-content">
                        <p><em>不含经典会员才能做的题</em></p>
<h1 id="1114-按序打印"><a class="header-anchor" href="#1114-按序打印"># </a>1114 按序打印</h1>
<p><a href="https://leetcode-cn.com/problems/print-in-order/" target="_blank" rel="noopener">传送门</a></p>
<h2 id="信号量-semaphore-h"><a class="header-anchor" href="#信号量-semaphore-h"># </a>信号量 semaphore.h</h2>
<pre><code class="language-cpp">#include &lt;semaphore.h&gt;
class Foo {
private:
    sem_t s1,s2;

public:
    Foo() {
        sem_init(&amp;s1,0,0);
        sem_init(&amp;s2,0,0);
    }

    void first(function&lt;void()&gt; printFirst) { 
        // printFirst() outputs &quot;first&quot;. Do not change or remove this line.
        printFirst();
        sem_post(&amp;s1);
    }

    void second(function&lt;void()&gt; printSecond) {
        sem_wait(&amp;s1);
        // printSecond() outputs &quot;second&quot;. Do not change or remove this line.
        printSecond();
        sem_post(&amp;s2);
    }

    void third(function&lt;void()&gt; printThird) {
        sem_wait(&amp;s2);
        // printThird() outputs &quot;third&quot;. Do not change or remove this line.
        printThird();
    }
};
</code></pre>
<blockquote>
<p>执行用时：144 ms<br>
内存消耗：8.4 MB</p>
</blockquote>
<h2 id="互斥信号量-mutex-C-11"><a class="header-anchor" href="#互斥信号量-mutex-C-11"># </a>互斥信号量 mutex (C++ 11)</h2>
<pre><code class="language-cpp">class Foo {
private:
    mutex m1, m2;

public:
    Foo() {
        m1.lock();
        m2.lock();
    }

    void first(function&lt;void()&gt; printFirst) {
        // printFirst() outputs &quot;first&quot;. Do not change or remove this line.
        printFirst();
        m1.unlock();
    }

    void second(function&lt;void()&gt; printSecond) {
        m1.lock();
        // printSecond() outputs &quot;second&quot;. Do not change or remove this line.
        printSecond();
        m2.unlock();
    }

    void third(function&lt;void()&gt; printThird) {
        m2.lock();
        // printThird() outputs &quot;third&quot;. Do not change or remove this line.
        printThird();
    }
};
</code></pre>
<blockquote>
<p>执行用时：124 ms<br>
内存消耗：8.5 MB</p>
</blockquote>
<h1 id="1115-Bar"><a class="header-anchor" href="#1115-Bar"># </a>1115 Bar</h1>
<p><a href="https://leetcode-cn.com/problems/print-foobar-alternately/" target="_blank" rel="noopener">传送门</a></p>
<pre><code class="language-cpp">class FooBar {
private:
    int n;
    mutex m1,m2;

public:
    FooBar(int n) {
        this-&gt;n = n;
        m1.lock();
        m2.unlock();
    }

    void foo(function&lt;void()&gt; printFoo) {
        for (int i = 0; i &lt; n; i++) {
            m2.lock();
            // printFoo() outputs &quot;foo&quot;. Do not change or remove this line.
            printFoo();
            m1.unlock();
        }
    }

    void bar(function&lt;void()&gt; printBar) {
        for (int i = 0; i &lt; n; i++) {
            m1.lock();
            // printBar() outputs &quot;bar&quot;. Do not change or remove this line.
            printBar();
            m2.unlock();
        }
    }
};
</code></pre>
<h1 id="1116-打印零与奇偶数"><a class="header-anchor" href="#1116-打印零与奇偶数"># </a>1116 打印零与奇偶数</h1>
<p><a href="https://leetcode-cn.com/problems/print-zero-even-odd/" target="_blank" rel="noopener">传送门</a></p>
<pre><code class="language-cpp">class ZeroEvenOdd {
private:
    int n;
    mutex z,e,o;

public:
    ZeroEvenOdd(int n) {
        this-&gt;n = n;
        z.unlock();
        e.lock();
        o.lock();
    }

    // printNumber(x) outputs &quot;x&quot;, where x is an integer.
    void zero(function&lt;void(int)&gt; printNumber) {
        for(int i=1;i&lt;=n;i++){
            z.lock();
            printNumber(0);
            if(i%2)o.unlock();
            else e.unlock();
        }
    }

    void even(function&lt;void(int)&gt; printNumber) {
        for(int i=2;i&lt;=n;i+=2){
            e.lock();
            printNumber(i);
            z.unlock();
        }
    }

    void odd(function&lt;void(int)&gt; printNumber) {
        for(int i=1;i&lt;=n;i+=2){
            o.lock();
            printNumber(i);
            z.unlock();
        }
    }
};
</code></pre>
<h1 id="1117-H2O-生成"><a class="header-anchor" href="#1117-H2O-生成"># </a>1117 H2O 生成</h1>
<p><a href="https://leetcode-cn.com/problems/building-h2o/" target="_blank" rel="noopener">传送门</a></p>
<pre><code class="language-cpp">#include &lt;semaphore.h&gt;
class H2O {
private:
    sem_t h,o;
    int cnt;

public:
    H2O() {
        sem_init(&amp;h, 0, 2);
        sem_init(&amp;o, 0, 1);
        cnt=0;
    }

    void hydrogen(function&lt;void()&gt; releaseHydrogen) {
        sem_wait(&amp;h);
        // releaseHydrogen() outputs &quot;H&quot;. Do not change or remove this line.
        releaseHydrogen();
        cnt++;
        if(cnt==2){
            sem_post(&amp;o);
            cnt=0;
        }
    }

    void oxygen(function&lt;void()&gt; releaseOxygen) {
        sem_wait(&amp;o);
        // releaseOxygen() outputs &quot;O&quot;. Do not change or remove this line.
        releaseOxygen();
        sem_post(&amp;h);
        sem_post(&amp;h);
    }
};
</code></pre>
<h1 id="1195-交替打印字符串"><a class="header-anchor" href="#1195-交替打印字符串"># </a>1195 交替打印字符串</h1>
<p><a href="https://leetcode-cn.com/problems/fizz-buzz-multithreaded/" target="_blank" rel="noopener">传送门</a></p>
<pre><code class="language-cpp">class FizzBuzz {
private:
    int n;
    mutex f,b,fb,num;

public:
    FizzBuzz(int n) {
        this-&gt;n = n;
        f.lock();
        b.lock();
        fb.lock();
    }

    // printFizz() outputs &quot;fizz&quot;.
    void fizz(function&lt;void()&gt; printFizz) {
        for(int i=3;i&lt;=n;i+=3){
            if(i%5==0)continue;
            f.lock();
            printFizz();
            num.unlock();
        }
    }

    // printBuzz() outputs &quot;buzz&quot;.
    void buzz(function&lt;void()&gt; printBuzz) {
        for(int i=5;i&lt;=n;i+=5){
            if(i%3==0)continue;
            b.lock();
            printBuzz();
            num.unlock();
        }
    }

    // printFizzBuzz() outputs &quot;fizzbuzz&quot;.
    void fizzbuzz(function&lt;void()&gt; printFizzBuzz) {
        for(int i=15;i&lt;=n;i+=15){
            fb.lock();
            printFizzBuzz();
            num.unlock();
        }
    }

    // printNumber(x) outputs &quot;x&quot;, where x is an integer.
    void number(function&lt;void(int)&gt; printNumber) {
        for(int i=1;i&lt;=n;i++){
            num.lock();
            if(i%3==0&amp;&amp;i%5==0)fb.unlock();
            else if(i%3==0)f.unlock();
            else if(i%5==0)b.unlock();
            else {
                printNumber(i);
                num.unlock();
            }
        }
    }
};
</code></pre>
<h1 id="1226-哲学家进餐"><a class="header-anchor" href="#1226-哲学家进餐"># </a>1226 哲学家进餐</h1>
<p><a href="https://leetcode-cn.com/problems/the-dining-philosophers/" target="_blank" rel="noopener">传送门</a><br>
操作系统书上的例子<br>
用一个信号量表示一只叉子，由这五个信号量构成信号量数组</p>
<pre><code class="language-cpp">class DiningPhilosophers {
private:
    mutex fork[5];
public:
    DiningPhilosophers() {
        
    }

    void wantsToEat(int philosopher,
                    function&lt;void()&gt; pickLeftFork,
                    function&lt;void()&gt; pickRightFork,
                    function&lt;void()&gt; eat,
                    function&lt;void()&gt; putLeftFork,
                    function&lt;void()&gt; putRightFork) {
        fork[philosopher].lock();
        pickLeftFork();
        fork[(philosopher+1)%5].lock();
        pickRightFork();
        eat();
        putLeftFork();
        fork[philosopher].unlock();
        putRightFork();
        fork[(philosopher+1)%5].unlock();
    }
};
</code></pre>
<p>虽然通过提交了，但是存在缺陷，可能会造成<strong>死锁</strong>。假如五位哲学家同时饥饿而各自拿起左边的叉子时，就会使五个互斥信号量均被锁住，当他们再试图去拿右边的叉子时，都将因无叉子可拿而无限期地等待。<br>
总共有<strong>三种</strong>解决方法：</p>
<h2 id="最多可允许四位哲学家同时进餐"><a class="header-anchor" href="#最多可允许四位哲学家同时进餐"># </a>最多可允许四位哲学家同时进餐</h2>
<p>至多只允许有四位哲学家同时去拿左边的叉子，最终能保证至少有一位哲学家能够进餐，并在用毕时能释放出他用过的两只叉子，从而使更多的哲学家能够进餐。</p>
<pre><code class="language-cpp">#include &lt;semaphore.h&gt;
class DiningPhilosophers {
private:
    sem_t s,fork[5];
public:
    DiningPhilosophers() {
        // 最多只允许4位同时进餐
        sem_init(&amp;s,0,4);
        // 叉子的信号量
        for(int i=0;i&lt;5;i++){
            sem_init(&amp;fork[i],0,1);
        }
    }

    void wantsToEat(int philosopher,
                    function&lt;void()&gt; pickLeftFork,
                    function&lt;void()&gt; pickRightFork,
                    function&lt;void()&gt; eat,
                    function&lt;void()&gt; putLeftFork,
                    function&lt;void()&gt; putRightFork) {
        int l=philosopher,r=(philosopher+1)%5;
        sem_wait(&amp;s);
        sem_wait(&amp;fork[l]);
        pickLeftFork();
        sem_wait(&amp;fork[r]);
        pickRightFork();
        eat();
        putLeftFork();
        sem_post(&amp;fork[l]);
        putRightFork();
        sem_post(&amp;fork[r]);
        sem_post(&amp;s);
    }
};
</code></pre>
<blockquote>
<p>执行用时：224 ms<br>
内存消耗：13.2 MB</p>
</blockquote>
<h2 id="同时拿左右两只叉子"><a class="header-anchor" href="#同时拿左右两只叉子"># </a>同时拿左右两只叉子</h2>
<p>仅当哲学家的左、右两只叉子均可用时，才允许他拿起叉子进餐。需要使用信号量集（AND型信号量）。<br>
说实话我不知道这个AND型信号量要怎么同时拿叉子，书上写的Sswait也是一个for循环按顺序控制，如果同时处理Sswait的话感觉还是解决不了五人同时相吃饭的问题（因为左右两个叉子的信号量都是1，同时拿的操作其实还是按顺序的，先拿左再拿右，如果五个人左边都拿了，那么右边就都死锁了）。<br>
所以我多设置了一个信号量，当两只叉子都被拿起的时候，只能允许最多<strong>两个人</strong>同时进餐。</p>
<pre><code class="language-cpp">#include &lt;semaphore.h&gt;
class DiningPhilosophers {
private:
    sem_t fork[5],s;
public:
    DiningPhilosophers() {
        // 如果同时拿起两只叉子的话，可以同时有两个人进餐
        sem_init(&amp;s,0,2);
        // 当且仅当两只叉子均可用的时候，可以进餐
        sem_init(&amp;s,0,1);
        for(int i=0;i&lt;5;i++){
            sem_init(&amp;fork[i],0,1);
        }
    }
    
    // AND 型信号量
    void Sswait(sem_t left,sem_t right){
        int lval,rval;
        sem_getvalue(&amp;left,&amp;lval);
        sem_getvalue(&amp;right,&amp;rval);
        if(lval==1&amp;&amp;rval==1){
            sem_wait(&amp;s);
            sem_wait(&amp;left);
            sem_wait(&amp;right);
        }
    }

    void wantsToEat(int philosopher,
                    function&lt;void()&gt; pickLeftFork,
                    function&lt;void()&gt; pickRightFork,
                    function&lt;void()&gt; eat,
                    function&lt;void()&gt; putLeftFork,
                    function&lt;void()&gt; putRightFork) {
        int l=philosopher,r=(philosopher+1)%5;
        Sswait(fork[l],fork[r]);
        pickLeftFork();
        pickRightFork();
        eat();
        putLeftFork();
        sem_post(&amp;fork[l]);
        putRightFork();
        sem_post(&amp;fork[r]);
        sem_post(&amp;s);
    }
};
</code></pre>
<blockquote>
<p>执行用时：204 ms<br>
内存消耗：13.4 MB</p>
</blockquote>
<h2 id="先拿奇数号叉子，再拿偶数号叉子"><a class="header-anchor" href="#先拿奇数号叉子，再拿偶数号叉子"># </a>先拿奇数号叉子，再拿偶数号叉子</h2>
<p>规定奇数号哲学家先拿他左边的叉子，然后再去拿右边的叉子，而偶数号哲学家则相反。即五位哲学家都先竞争奇数号叉子，获得后，再去竞争偶数号叉子，最后总会有一位哲学家能获得两只叉子而进餐。</p>
<pre><code class="language-cpp">class DiningPhilosophers {
private:
    mutex fork[5];
public:
    DiningPhilosophers() {

    }

    void wantsToEat(int philosopher,
                    function&lt;void()&gt; pickLeftFork,
                    function&lt;void()&gt; pickRightFork,
                    function&lt;void()&gt; eat,
                    function&lt;void()&gt; putLeftFork,
                    function&lt;void()&gt; putRightFork) {
        int l=philosopher,r=(philosopher+1)%5;
        if(philosopher%2){
            fork[l].lock();
            pickLeftFork();
            fork[r].lock();
            pickRightFork();
        }else{
            fork[r].lock();
            pickRightFork();
            fork[l].lock();
            pickLeftFork();
        }
        eat();
        putLeftFork();
        fork[l].unlock();
        putRightFork();
        fork[r].unlock();
    }
};
</code></pre>
<blockquote>
<p>执行用时：212 ms<br>
内存消耗：13.6 MB</p>
</blockquote>

                    </article>
                    <!-- ccmark -->
                    <br />
                    <div align="right" class="ccmark">
                        <i class="fab fa-creative-commons"></i>
                        <i class="fab fa-creative-commons-by"></i>
                        <i class="fab fa-creative-commons-sa"></i>
                    </div>
                    <hr />
<div class="write-paginator">
    <div class="contain-fluid">
        
        <div class="row justify-content-between mx-0">
            
            <a class="write-prev-post col-5 text-left" href="/2020/09/VSCO/">
                <i class="fa fa-angle-left"></i>&emsp;用 Visual Studio 帮助学习《计算机组成原理》
            </a>
            
            
            <a class="write-next-post col-5 text-right" href="/2020/03/InstallCUDA10/">
                在 Windows 10 上安装 CUDA 10.0&emsp;<i class="fa fa-angle-right"></i>
            </a>
            
        </div>
        
    </div>
</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-xl-4">
    <!-- toc -->
    <div class="write-toc"></div>
</div>
    </div>
</div>
        <footer class="write-footer w-100">
    <a href="https://hexo.io/" class="write-blog-link" target="_blank">Hexo</a> Theme Write by <a
        href="https://lxyyxxx.github.io/" class="write-blog-link" target="_blank">Lin Xinyu</a>
    <br>
    &copy; 2022 <a href="https://lxyyxxx.github.io" class="write-blog-link">
            Lin Xinyu
        </a>
</footer>
    </div>
    <!-- bootstrap -->
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.slim.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>

<!-- tocbot -->
<script src="https://cdn.bootcdn.net/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>

<!-- mermaid -->
<script async src="https://unpkg.com/mermaid@8.6.0/dist/mermaid.min.js"></script>

<!-- highlight js-->
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.18.1/highlight.min.js">
</script>
<!-- uncommon highlight -->
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.18.1/languages/matlab.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.18.1/languages/cmake.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.18.1/languages/x86asm.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.18.1/languages/powershell.min.js"></script>

<!-- theme js -->
<script src="/js/write.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>

</html>